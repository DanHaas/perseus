{"state":{"content":"<h1>Global state</h1>\n<p>Like any state management system worth its salt, Perseus also has a global state system, which is managed analogously to templates, through the <a href=\"https://docs.rs/perseus/0.4/perseus/state/struct.GlobalStateCreator.html\"><code>GlobalStateCreator</code></a> API. As with templates, you can generate build-time global state, request-time global state, and you can even amalgamate the two! Here's an example of all three working together:</p>\n<pre><code class=\"language-rust\">use perseus::{prelude::*, state::GlobalStateCreator};\nuse serde::{Deserialize, Serialize};\n\npub fn get_global_state_creator() -&gt; GlobalStateCreator {\n    GlobalStateCreator::new()\n        .build_state_fn(get_build_state)\n        .request_state_fn(get_request_state)\n        .amalgamate_states_fn(amalgamate_states)\n}\n\n#[derive(Serialize, Deserialize, ReactiveState)]\n#[rx(alias = &quot;AppStateRx&quot;)]\npub struct AppState {\n    pub test: String,\n}\n\n// All the below functions can return either `AppState`, or `Result&lt;AppState,\n// E&gt;`, where `E` is some error type. For concision, these examples cannot\n// return errors. Request state and state amalgamation use `BlamedError`s if\n// they're fallible.\n\n// Global state will be generated for each locale in your app (but we don't\n// worry about that in this example)\n#[engine_only_fn]\nasync fn get_build_state() -&gt; AppState {\n    AppState {\n        test: &quot;Hello from the build process!&quot;.to_string(),\n    }\n}\n\n// This will be executed every time there's a request to any page in your app\n// (you should avoid doing heavy work here if possible). Note that using *only*\n// request-time global state generation, without anything at build-time, would\n// prevent your app from accessing global state during the build process, so be\n// certain that's what you want if you go down that path.\n#[engine_only_fn]\nasync fn get_request_state(_req: Request) -&gt; AppState {\n    AppState {\n        test: &quot;Hello from the server!&quot;.to_string(),\n    }\n}\n\n// You can even combine build state with request state, just like in a template!\n#[engine_only_fn]\nasync fn amalgamate_states(build_state: AppState, request_state: AppState) -&gt; AppState {\n    AppState {\n        test: format!(\n            &quot;Message from the builder: '{}' Message from the server: '{}'&quot;,\n            build_state.test, request_state.test,\n        ),\n    }\n}\n\n</code></pre>\n<p>Note the definition of a reactive state type <code>AppState</code> (which does not have to be <code>Clone</code>, unlike page state types), and the lack of <code>StateGeneratorInfo</code>: since there are no paths or helper state in the global state system, all you get is a locale (since some apps will need locale-specific global state). As with other state generator functions, these are <code>async</code> and can either be fallible or infallible, at your choice. Due to the lack of revalidation or incremental generation support (neither of which are planned) in global state, the build state generator can never be run at request-time, and therefore returns unblamed errors. To learn more about state generator error handling, see <a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/build\">here</a>.</p>\n<p>Notice also the use of a <code>get_global_state_creator()</code> function that returns an instance of <code>GlobalStateCreator</code>. This is analogous to the <code>get_template()</code> functions you may be used to.</p>\n<h2>Using global state</h2>\n<p>Since it's not provided as an argument to your views, you can access your global state through the <a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/reactor\">reactor</a>, as in this example:</p>\n<pre><code class=\"language-rust\">use crate::global_state::AppStateRx;\nuse perseus::prelude::*;\nuse sycamore::prelude::*;\n\n// Note that this template takes no state of its own in this example, but it\n// certainly could\nfn index_page&lt;G: Html&gt;(cx: Scope) -&gt; View&lt;G&gt; {\n    // We access the global state through the render context, extracted from\n    // Sycamore's context system\n    let global_state = Reactor::&lt;G&gt;::from_cx(cx).get_global_state::&lt;AppStateRx&gt;(cx);\n\n    view! { cx,\n        // The user can change the global state through an input, and the changes they make will be reflected throughout the app\n        p { (global_state.test.get()) }\n        input(bind:value = global_state.test)\n\n        a(href = &quot;about&quot;, id = &quot;about-link&quot;) { &quot;About&quot; }\n    }\n}\n\n#[engine_only_fn]\nfn head(cx: Scope) -&gt; View&lt;SsrNode&gt; {\n    view! { cx,\n        title { &quot;Index Page&quot; }\n    }\n}\n\npub fn get_template&lt;G: Html&gt;() -&gt; Template&lt;G&gt; {\n    Template::build(&quot;index&quot;).view(index_page).head(head).build()\n}\n\n</code></pre>\n<p>The <code>.get_global_state::&lt;T&gt;()</code> method is used, where <code>T</code> is the reactive version of the global state type. Providing the wrong type here will lead to a panic, and you can use <code>.try_get_global_state()</code> instead if you wish. These functions return a reference to the reactive version of your global state, with the lifetime of the page they were executed in, allowing interpolation.</p>\n<p>Note that the global state has its own version of the page state store, and is cached in a reactive fashion, meaning updates to it on one page will be preserved on other pages. This makes the global state extremely helpful for storing things like user volume preferences in a music app, which might be changed from any song page.</p>\n<h2>Pitfalls of request-time global state</h2>\n<p>Absolutely critically, if you are using only request-time global state, and you use the <code>.get_global_state()</code> method <em>anywhere</em> in your app that uses build state, you will experience panics at build-time. This is because Perseus does not attempt to prevent pages from accessing global state at build-time, even if it won't exist until request-time: policing this is your responsibility. Further, even if you set sensible defaults at build-time and override these at request-time, any pages that only use build state will never see the request-time state until the client-side, which can lead to hydration errors. In general, be cautious when using request-time global state, as improper usage of it abounds, and it can be highly error-prone. If in doubt, avoid it.</p>\n","current_version":"0.4.x","manifest":{"0.1.x":{"docs_rs":"0.1","git":"v0.1.4","state":"outdated"},"0.2.x":{"docs_rs":"0.2","git":"v0.2.3","state":"outdated"},"0.3.0-0.3.3":{"docs_rs":"0.3.3","git":"v0.3.3","state":"outdated"},"0.3.4":{"docs_rs":"0.3","git":"v0.3.6","state":"outdated"},"0.4.x":{"docs_rs":"0.4","git":"HEAD","state":"stable"}},"sidebar_content":"<h1>Introduction</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/intro\">Introduction</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/quickstart\">Quickstart</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/what-is-perseus\">What is Perseus?</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/core-principles\">Core Principles</a></li>\n</ul>\n<h1>Your First App</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/installation\">Installing Perseus</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/defining\">Defining your app</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/generating-pages\">Generating pages</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/dev-cycle\">Development cycle</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/error-handling\">Error handling</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/first-app/deploying\">Deploying your app</a></li>\n</ul>\n<h1>Fundamentals</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/perseus-app\"><code>PerseusApp</code></a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/reactor\">The reactor</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/routing\">Routing and navigation</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/preloading\">Preloading</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/i18n\">Internationalization</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/error-views\">Error views</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/hydration\">Hydration</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/static-content\">Static content</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/head-headers\">Heads and headers</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/styling\">Styling</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/js-interop\">Working with JS</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/serving-exporting\">Servers and exporting</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/debugging\">Debugging</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/testing\">Writing tests</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/plugins\">Plugins</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/fundamentals/compilation-times\">Improving Compilation Times</a></li>\n</ul>\n<h1>The State Platform</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/intro\">Understanding state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/build\">Build-time state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/request\">Request-time state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/revalidation\">Revalidation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/incremental\">Incremental generation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/amalgamation\">State amalgamation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/browser\">Using state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/global\">Global state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/helper\">Helper state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/suspense\">Suspended state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/freezing-thawing\">Freezing and thawing</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/state/manual\">Manually implementing <code>ReactiveState</code></a></li>\n</ul>\n<h1>Capsules</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/capsules/intro\">Introduction</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/capsules/using\">Using capsules</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/capsules/capsules-vs-components\">Capsules vs. components</a></li>\n</ul>\n<h1>Miscellaneous</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/migrating\">Migrating from v0.3.x</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.4.x/faq\">Common pitfalls and FAQs</a></li>\n</ul>\n","status":"Stable","title":"Global state"},"head":"<title>Global state | Perseus Docs</title><link rel=stylesheet href=.perseus/static/styles/markdown.css><link rel=stylesheet href=.perseus/static/styles/docs_links_markdown.css><link rel=stylesheet href=.perseus/static/prism.css>"}